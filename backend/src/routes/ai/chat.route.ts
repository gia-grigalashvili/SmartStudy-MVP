import { Router, Request, Response } from "express";
import { GoogleGenerativeAI } from "@google/generative-ai";
import { getEnvVariable } from "@/config";

const router = Router();

const genAI = new GoogleGenerativeAI(getEnvVariable("GEMINI_API_KEY") || "áƒ’áƒáƒ›áƒáƒ áƒ¯áƒ‘áƒáƒ");

router.post("/chat", async (req: Request, res: Response) => {
  try {
    const { message, history } = req.body;

    if (!message) {
      return res.status(400).json({ error: "Message is required" });
    }

    const model = genAI.getGenerativeModel({ model: "gemini-2.5-pro" });

    const isTestRequest =
      message.toLowerCase().includes("áƒ¢áƒ”áƒ¡áƒ¢") ||
      message.toLowerCase().includes("test") ||
      message.toLowerCase().includes("áƒ¨áƒ”áƒ™áƒ˜áƒ—áƒ®áƒ•");

    let prompt = message;
    let systemPrompt = `áƒ¨áƒ”áƒœ áƒ®áƒáƒ  AI áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ”áƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡. áƒ“áƒáƒ”áƒ®áƒ›áƒáƒ áƒ” áƒ›áƒáƒ— áƒ¡áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ áƒ›áƒáƒ¡áƒáƒšáƒ”áƒ‘áƒ¨áƒ˜, áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒ áƒ—áƒ£áƒšáƒ˜ áƒ—áƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒáƒ“ áƒ“áƒ áƒ’áƒáƒ¡áƒáƒ’áƒ”áƒ‘áƒáƒ“. áƒáƒáƒ¡áƒ£áƒ®áƒáƒ‘ áƒ¥áƒáƒ áƒ—áƒ£áƒš áƒ”áƒœáƒáƒ–áƒ” áƒ“áƒ áƒ§áƒáƒ•áƒ”áƒšáƒ—áƒ•áƒ˜áƒ¡ áƒ›áƒ”áƒ’áƒáƒ‘áƒ áƒ£áƒšáƒáƒ“ áƒ“áƒ áƒ›áƒ®áƒáƒ áƒ“áƒáƒ›áƒ­áƒ”áƒ áƒáƒ“.`;

    if (isTestRequest) {
      systemPrompt = `áƒ¨áƒ”áƒœ áƒ¥áƒ›áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ”áƒ‘áƒ¡ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ”áƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡. áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ˜áƒ› áƒ—áƒ”áƒ›áƒáƒ–áƒ” áƒ áƒáƒª áƒ›áƒáƒ—áƒ®áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ.

      á²›á²œá²˜á²¨á²•á²œá²”á²šá²á²•á²á²œá²˜: áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒáƒ› áƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ¨áƒ˜:
      {
        "type": "test",
        "topic": "áƒ—áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜",
        "questions": [
          {
            "question": "áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ˜áƒ¡ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜",
            "options": ["áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ˜ A", "áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ˜ B", "áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ˜ C", "áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ˜ D"],
            "correct": 0
          }
        ]
      }

      - áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜ 5 áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ
      - correct áƒáƒ áƒ˜áƒ¡ áƒ¡áƒ¬áƒáƒ áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡ áƒ˜áƒœáƒ“áƒ”áƒ¥áƒ¡áƒ˜ (0, 1, 2, áƒáƒœ 3)
      - áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ áƒ“áƒáƒœáƒ˜áƒ¡
      - áƒ“áƒáƒáƒ‘áƒ áƒ£áƒœáƒ” áƒ›áƒ®áƒáƒšáƒáƒ“ JSON, áƒáƒ áƒáƒ¤áƒ”áƒ áƒ˜ áƒ¡áƒ®áƒ•áƒ`;
    }

    const fullPrompt = `${systemPrompt}\n\náƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ¡ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ: ${prompt}`;

    // If client accepts streaming, respond as text/event-stream and stream partial text
    const wantsStream =
      (req.headers['accept'] || '').includes('text/event-stream') ||
      req.query.stream === '1' ||
      req.headers['x-stream'] === '1';

    if (wantsStream) {
      // SSE-style streaming
      res.setHeader('Content-Type', 'text/event-stream; charset=utf-8');
      res.setHeader('Cache-Control', 'no-cache, no-transform');
      res.setHeader('Connection', 'keep-alive');
      // flush headers
      res.flushHeaders?.();

      try {
        const result = await model.generateContent(fullPrompt);
        const responseObj: any = result.response;

        let testData: any = null;

        // If library exposes a streamable body (ReadableStream), try to consume it directly
        if (responseObj?.body && typeof responseObj.body.getReader === 'function') {
          const reader = responseObj.body.getReader();
          const decoder = new TextDecoder();
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunkText = decoder.decode(value, { stream: true });
            // send chunk as SSE data
            res.write(`data: ${chunkText.replace(/\n/g, '\\n')}\n\n`);
          }
        } else {
          // Fallback: get full text then stream it in slices so client can receive progressively
          let text = await responseObj.text();

          // try parse test JSON if present (for test requests)
          if (isTestRequest) {
            try {
              const jsonMatch = text.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                testData = JSON.parse(jsonMatch[0]);
                // remove JSON from streamed text summary (so client doesn't show huge JSON inline)
                text = `áƒ¨áƒ”áƒ•áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ—áƒ”áƒ›áƒáƒ–áƒ”: ${testData.topic}. áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ¡ ${testData.questions.length} áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ¡. áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒªáƒ”áƒ›áƒ!`;
              }
            } catch (e) {
              console.error("Failed to parse test JSON:", e);
            }
          }

          const chunkSize = 120; // chars per chunk
          for (let i = 0; i < text.length; i += chunkSize) {
            const part = text.slice(i, i + chunkSize);
            res.write(`data: ${part.replace(/\n/g, '\\n')}\n\n`);
          }

          // if no test JSON parsed earlier and it is a test request try final parse now
          if (isTestRequest && !testData) {
            try {
              const jsonMatch = responseObj.text().match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                testData = JSON.parse(jsonMatch[0]);
              }
            } catch (e) {
              // ignore parsing failure
            }
          }
        }

        // send test JSON as a special event if present so client can detect and parse it
        if (isTestRequest && testData) {
          // use a distinct event name for structured payload
          res.write(`event: test\n`);
          res.write(`data: ${JSON.stringify(testData)}\n\n`);
        }

        // indicate done
        res.write(`event: done\n`);
        res.write(`data: [DONE]\n\n`);
        res.end();
        return;
      } catch (err) {
        console.error('Stream generation error:', err);
        res.write(`event: error\n`);
        res.write(`data: ${JSON.stringify({ message: 'áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ’áƒ”áƒœáƒ”áƒ áƒáƒªáƒ˜áƒ˜áƒ¡áƒáƒ¡' })}\n\n`);
        res.end();
        return;
      }
    }

    // Non-streaming fallback: original behaviour (return full JSON)
    const result = await model.generateContent(fullPrompt);
    const response = result.response;
    console.log("AI Chat Result:", response);
    let text = response.text();

    let testData = null;
    if (isTestRequest) {
      try {
        const jsonMatch = (await text).match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          testData = JSON.parse(jsonMatch[0]);
          text = `áƒ¨áƒ”áƒ•áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ—áƒ”áƒ›áƒáƒ–áƒ”: ${testData.topic}. áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ¡ ${testData.questions.length} áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ¡. áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒªáƒ”áƒ›áƒ!`;
        } else {
          text = await text;
        }
      } catch (e) {
        console.error("Failed to parse test JSON:", e);
        text = await text;
      }
    } else {
      text = await text;
    }

    res.json({
      response: text,
      test: testData,
    });
  } catch (error) {
    console.log("AI Chat Error:", error);
    res.status(500).json({
      error: "Internal server error",
      response: "áƒ‘áƒáƒ“áƒ˜áƒ¨áƒ˜, áƒ“áƒáƒ¤áƒ˜áƒ¥áƒ¡áƒ˜áƒ áƒ“áƒ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ. áƒ’áƒ—áƒ®áƒáƒ• áƒ¡áƒªáƒáƒ“áƒ áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ.",
    });
  }
});

export default router;

// import { Router, Request, Response } from "express";
// import { GoogleGenerativeAI } from "@google/generative-ai";
// import { getEnvVariable } from "@/config";

// const router = Router();

// const genAI = new GoogleGenerativeAI(getEnvVariable("GEMINI_API_KEY"));

// // áƒ«áƒ˜áƒ áƒ˜áƒ—áƒáƒ“áƒ˜ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ£áƒ áƒ˜ áƒáƒ áƒáƒ›áƒáƒ¢áƒ˜ áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡
// const EDUCATION_SYSTEM_PROMPT = `áƒ¨áƒ”áƒœ áƒ®áƒáƒ  áƒáƒ áƒáƒ¤áƒ”áƒ¡áƒ˜áƒáƒœáƒáƒšáƒ˜ AI áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒ˜ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ”áƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ (1-12 áƒ™áƒšáƒáƒ¡áƒ˜). áƒ¨áƒ”áƒœáƒ˜ áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒ›áƒ˜áƒ–áƒáƒœáƒ˜áƒ áƒ¡áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ áƒáƒ áƒáƒªáƒ”áƒ¡áƒ¨áƒ˜ áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ áƒ“áƒ áƒªáƒáƒ“áƒœáƒ˜áƒ¡ áƒ’áƒáƒ¦áƒ áƒ›áƒáƒ•áƒ”áƒ‘áƒ.

// ğŸ¯ á²¨á²”á²œá²˜ áƒ áƒáƒšáƒ˜:
// - áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ®áƒ”áƒšáƒ¨áƒ”áƒ›áƒ¬áƒ§áƒáƒ‘áƒ˜ áƒ“áƒ áƒ›áƒáƒ¢áƒ˜áƒ•áƒáƒ¢áƒáƒ áƒ˜
// - áƒ áƒ—áƒ£áƒšáƒ˜ áƒ™áƒáƒœáƒªáƒ”áƒ¤áƒªáƒ˜áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒáƒ“ áƒáƒ›áƒ®áƒ¡áƒœáƒ”áƒšáƒ˜
// - áƒ˜áƒœáƒ¢áƒ”áƒ áƒáƒ¥áƒ¢áƒ˜áƒ£áƒšáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ¥áƒ›áƒœáƒ”áƒšáƒ˜
// - áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ¡ áƒ˜áƒœáƒ“áƒ˜áƒ•áƒ˜áƒ“áƒ£áƒáƒšáƒ£áƒ áƒ˜ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ›áƒ—áƒ•áƒáƒšáƒ˜áƒ¡áƒ¬áƒ˜áƒœáƒ”áƒ‘áƒ”áƒšáƒ˜

// ğŸ“š á²¡á²á²’á²œá²”á²‘á²˜ áƒ áƒáƒ›áƒšáƒ”áƒ‘áƒ¨áƒ˜áƒª áƒ”áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ˜:
// - áƒ›áƒáƒ—áƒ”áƒ›áƒáƒ¢áƒ˜áƒ™áƒ (áƒáƒ áƒ˜áƒ—áƒ›áƒ”áƒ¢áƒ˜áƒ™áƒ, áƒáƒšáƒ’áƒ”áƒ‘áƒ áƒ, áƒ’áƒ”áƒáƒ›áƒ”áƒ¢áƒ áƒ˜áƒ, áƒ¢áƒ áƒ˜áƒ’áƒáƒœáƒáƒ›áƒ”áƒ¢áƒ áƒ˜áƒ)
// - áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ”áƒœáƒ áƒ“áƒ áƒšáƒ˜áƒ¢áƒ”áƒ áƒáƒ¢áƒ£áƒ áƒ
// - áƒ£áƒªáƒ®áƒ áƒ”áƒœáƒ”áƒ‘áƒ˜ (áƒ˜áƒœáƒ’áƒšáƒ˜áƒ¡áƒ£áƒ áƒ˜, áƒ áƒ£áƒ¡áƒ£áƒšáƒ˜)
// - áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ (áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒáƒ¡ áƒ“áƒ áƒ›áƒ¡áƒáƒ¤áƒšáƒ˜áƒ)
// - áƒ’áƒ”áƒáƒ’áƒ áƒáƒ¤áƒ˜áƒ
// - áƒ‘áƒ˜áƒáƒšáƒáƒ’áƒ˜áƒ, áƒ¥áƒ˜áƒ›áƒ˜áƒ, áƒ¤áƒ˜áƒ–áƒ˜áƒ™áƒ
// - áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ˜áƒ™áƒ áƒ“áƒ áƒáƒ áƒáƒ’áƒ áƒáƒ›áƒ˜áƒ áƒ”áƒ‘áƒ
// - áƒ¡áƒáƒ›áƒáƒ¥áƒáƒšáƒáƒ¥áƒ áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ

// âœ… áƒ áƒáƒ’áƒáƒ  áƒáƒáƒ¡áƒ£áƒ®áƒáƒ‘ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ–áƒ”:
// 1. áƒ—áƒáƒ•áƒ“áƒáƒáƒ˜áƒ áƒ•áƒ”áƒšáƒáƒ“ áƒáƒ¤áƒáƒ¡áƒ”áƒ‘ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ¡ áƒ“áƒáƒœáƒ”áƒ¡ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ˜áƒ“áƒáƒœ
// 2. áƒ®áƒ¡áƒœáƒ˜ áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ˜, áƒ’áƒáƒ¡áƒáƒ’áƒ”áƒ‘áƒ˜ áƒ”áƒœáƒ˜áƒ—
// 3. áƒ˜áƒ§áƒ”áƒœáƒ”áƒ‘ áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒš áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ”áƒ‘áƒ¡ áƒ§áƒáƒ•áƒ”áƒšáƒ“áƒ¦áƒ˜áƒ£áƒ áƒ˜ áƒªáƒ®áƒáƒ•áƒ áƒ”áƒ‘áƒ˜áƒ“áƒáƒœ
// 4. áƒáƒœáƒ˜áƒ­áƒ”áƒ‘ áƒáƒ áƒáƒ’áƒ áƒ”áƒ¡áƒ£áƒš áƒ¡áƒ˜áƒ áƒ—áƒ£áƒšáƒ”áƒ¡
// 5. áƒáƒ«áƒšáƒ”áƒ• áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ”áƒ‘áƒ¡ áƒ—áƒ£ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ
// 6. áƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘ áƒ’áƒáƒ’áƒ”áƒ‘áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—áƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ˜áƒ—

// âŒ áƒ áƒáƒ¡ áƒáƒ  áƒáƒ™áƒ”áƒ—áƒ”áƒ‘:
// - áƒáƒ  áƒ˜áƒ«áƒšáƒ”áƒ•áƒ áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ  áƒáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ¡ áƒ¡áƒáƒ¨áƒ˜áƒœáƒáƒ áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ”áƒ‘áƒ–áƒ” (áƒ”áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ˜ áƒ’áƒáƒáƒ–áƒ áƒ”áƒ‘áƒáƒ¨áƒ˜)
// - áƒáƒ  áƒ¡áƒáƒ£áƒ‘áƒ áƒáƒ‘ áƒáƒ áƒáƒ¡áƒáƒ¡áƒ™áƒáƒšáƒ áƒ—áƒ”áƒ›áƒ”áƒ‘áƒ–áƒ” (áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ, áƒ áƒ”áƒšáƒ˜áƒ’áƒ˜áƒ, áƒ•áƒ˜áƒáƒšáƒ”áƒœáƒ¡áƒ˜áƒ)
// - áƒáƒ  áƒáƒ‘áƒœáƒ”áƒ• áƒ áƒ—áƒ£áƒšáƒ˜ áƒ¢áƒ”áƒ áƒ›áƒ˜áƒœáƒáƒšáƒáƒ’áƒ˜áƒ˜áƒ—
// - áƒáƒ  áƒáƒ«áƒšáƒ”áƒ• áƒáƒ áƒáƒ¡áƒ¬áƒáƒ  áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒáƒ¡

// ğŸ’¬ á²™á²á²›á²£á²œá²˜á²™á²á²ªá²˜á²˜á²¡ áƒ¡áƒ¢áƒ˜áƒšáƒ˜:
// - áƒ›áƒ”áƒ’áƒáƒ‘áƒ áƒ£áƒšáƒ˜ áƒ“áƒ áƒ›áƒ®áƒáƒ áƒ“áƒáƒ›áƒ­áƒ”áƒ áƒ˜
// - áƒ›áƒáƒ—áƒ›áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒáƒœáƒ˜ áƒ“áƒ áƒ›áƒáƒ¢áƒ˜áƒ•áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜
// - áƒáƒáƒ–áƒ˜áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒ áƒ”áƒ˜áƒœáƒ¤áƒáƒ áƒ¡áƒ›áƒ”áƒœáƒ¢áƒ˜ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ”áƒ‘áƒ–áƒ”
// - áƒ˜áƒ®áƒ›áƒáƒ áƒ” emoji-áƒ”áƒ‘áƒ˜ áƒ”áƒœáƒ”áƒ áƒ’áƒ˜áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ ğŸŒŸğŸ“šâœ¨
// - áƒ“áƒáƒ”áƒšáƒáƒ“áƒ” áƒáƒáƒ¡áƒ£áƒ®áƒ¡ áƒ áƒ—áƒ£áƒš áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ–áƒ” ("áƒ™áƒáƒ áƒ’áƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ! áƒ›áƒáƒ“áƒ˜ áƒ•áƒ˜áƒ¤áƒ˜áƒ¥áƒ áƒáƒ— áƒ”áƒ áƒ—áƒáƒ“...")

// ğŸ“ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ¡ áƒ›áƒ®áƒáƒ áƒ“áƒáƒ­áƒ”áƒ áƒ:
// - áƒ—áƒ£ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ” áƒ˜áƒ‘áƒœáƒ”áƒ•áƒ: "áƒáƒ  áƒ˜áƒœáƒ”áƒ áƒ•áƒ˜áƒ£áƒšáƒ! áƒ”áƒ¡ áƒ áƒ—áƒ£áƒšáƒ˜ áƒ—áƒ”áƒ›áƒáƒ, áƒ›áƒáƒ’áƒ áƒáƒ› áƒ”áƒ áƒ—áƒáƒ“ áƒ’áƒáƒ•áƒáƒ áƒ—áƒ•áƒ˜áƒ— ğŸ’ª"
// - áƒ—áƒ£ áƒ¡áƒ¬áƒáƒ áƒáƒ“ áƒáƒáƒ¡áƒ£áƒ®áƒáƒ‘áƒ¡: "áƒ¨áƒ”áƒ¡áƒáƒœáƒ˜áƒ¨áƒœáƒáƒ•áƒ˜áƒ! ğŸŒŸ áƒ­áƒ™áƒ•áƒ˜áƒáƒœáƒáƒ“ áƒ˜áƒ¤áƒ˜áƒ¥áƒ áƒ”!"
// - áƒ—áƒ£ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ¡ áƒ£áƒ¨áƒ•áƒ”áƒ‘áƒ¡: "áƒ™áƒáƒ áƒ’áƒ˜ áƒ›áƒªáƒ“áƒ”áƒšáƒáƒ‘áƒ! áƒ›áƒáƒ“áƒ˜ áƒ¨áƒ”áƒ•áƒ®áƒ”áƒ“áƒáƒ— áƒ™áƒ˜áƒ“áƒ”áƒ• áƒ”áƒ áƒ—áƒ®áƒ”áƒš ğŸ¤”"

// á²›á²œá²˜á²¨á²•á²œá²”á²šá²á²•á²á²œá²˜: áƒ§áƒáƒ•áƒ”áƒšáƒ—áƒ•áƒ˜áƒ¡ áƒáƒáƒ¡áƒ£áƒ®áƒáƒ‘ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒáƒ“ áƒ“áƒ áƒ§áƒáƒ•áƒ”áƒšáƒ—áƒ•áƒ˜áƒ¡ áƒ¤áƒáƒ™áƒ£áƒ¡áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ  áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒáƒ–áƒ”!`;

// // áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ”áƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜ áƒáƒ áƒáƒ›áƒáƒ¢áƒ˜
// const TEST_CREATION_PROMPT = `áƒ¨áƒ”áƒœ áƒ¥áƒ›áƒœáƒ˜ áƒ˜áƒœáƒ¢áƒ”áƒ áƒáƒ¥áƒ¢áƒ˜áƒ£áƒš áƒ¢áƒ”áƒ¡áƒ¢áƒ”áƒ‘áƒ¡ áƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒ˜ áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ”áƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡.

// ğŸ¯ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒ¡ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜:

// 1. á²—á²”á²›á²˜á²¡ áƒáƒœáƒáƒšáƒ˜áƒ–áƒ˜:
//    - áƒ’áƒáƒáƒáƒœáƒáƒšáƒ˜áƒ–áƒ” áƒ áƒ áƒ—áƒ”áƒ›áƒáƒ–áƒ” áƒ˜áƒ®áƒ¡áƒ”áƒœáƒ”áƒ‘áƒ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜
//    - áƒ’áƒáƒœáƒ¡áƒáƒ–áƒ¦áƒ•áƒ áƒ” áƒ áƒáƒ›áƒ”áƒš áƒ™áƒšáƒáƒ¡áƒ¡ áƒ¨áƒ”áƒ”áƒ¤áƒ”áƒ áƒ”áƒ‘áƒ (1-12)
//    - áƒ’áƒáƒ˜áƒáƒ–áƒ áƒ” áƒ áƒ áƒ“áƒáƒœáƒ˜áƒ¡ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ˜

// 2. á²™á²˜á²—á²®á²•á²”á²‘á²˜á²¡ á²¡á²¢á² á²£á²¥á²¢á²£á² á²:
//    - áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜ 5 áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ
//    - áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒáƒ áƒáƒ’áƒ áƒ”áƒ¡áƒ£áƒšáƒ˜ (áƒáƒ“áƒ•áƒ˜áƒšáƒ˜áƒ“áƒáƒœ áƒ áƒ—áƒ£áƒšáƒáƒ›áƒ“áƒ”)
//    - áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒš áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ¡ 4 áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ˜ (A, B, C, D)
//    - áƒ›áƒ®áƒáƒšáƒáƒ“ 1 áƒ¡áƒ¬áƒáƒ áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜
//    - áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜ áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¯áƒ”áƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ›áƒáƒ’áƒ áƒáƒ› áƒáƒ¨áƒ™áƒáƒ áƒáƒ“ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜

// 3. á²™á²˜á²—á²®á²•á²”á²‘á²˜á²¡ á²¢á²˜á²á²”á²‘á²˜ (áƒ›áƒáƒ£áƒ áƒ—áƒáƒ•áƒ”):
//    - áƒ¤áƒáƒ¥áƒ¢áƒáƒ‘áƒ áƒ˜áƒ•áƒ˜ áƒªáƒáƒ“áƒœáƒ
//    - áƒ’áƒáƒ’áƒ”áƒ‘áƒ áƒ“áƒ áƒ’áƒáƒáƒ–áƒ áƒ”áƒ‘áƒ  
//    - áƒ’áƒáƒ›áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ áƒáƒ áƒáƒ¥áƒ¢áƒ˜áƒ™áƒáƒ¨áƒ˜
//    - áƒáƒœáƒáƒšáƒ˜áƒ–áƒ˜ áƒ“áƒ áƒ¡áƒ˜áƒœáƒ—áƒ”áƒ–áƒ˜
//    - áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ

// 4. á²—á²”á²›á²”á²‘á²˜á²¡ áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ”áƒ‘áƒ˜:
//    - áƒ›áƒáƒ—áƒ”áƒ›áƒáƒ¢áƒ˜áƒ™áƒ: "áƒáƒ˜áƒ—áƒáƒ’áƒáƒ áƒáƒ¡ áƒ—áƒ”áƒáƒ áƒ”áƒ›áƒ", "áƒ¬áƒ˜áƒšáƒáƒ“áƒ”áƒ‘áƒ˜", "áƒ’áƒáƒœáƒ¢áƒáƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜"
//    - áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜: "áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ˜ áƒ¬áƒ˜áƒœáƒáƒ“áƒáƒ“áƒ”áƒ‘áƒ", "áƒ–áƒ›áƒœáƒ˜áƒ¡ áƒ“áƒ áƒáƒ”áƒ‘áƒ˜", "áƒšáƒ˜áƒ¢áƒ”áƒ áƒáƒ¢áƒ£áƒ áƒ£áƒšáƒ˜ áƒ”áƒáƒáƒ¥áƒ”áƒ‘áƒ˜"
//    - áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ: "áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒáƒ¡ áƒ’áƒáƒ”áƒ áƒ—áƒ˜áƒáƒœáƒ”áƒ‘áƒ", "áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒ›áƒ¡áƒáƒ¤áƒšáƒ˜áƒ áƒáƒ›áƒ˜"
//    - áƒ‘áƒ˜áƒáƒšáƒáƒ’áƒ˜áƒ: "áƒ¤áƒáƒ¢áƒáƒ¡áƒ˜áƒœáƒ—áƒ”áƒ–áƒ˜", "áƒ£áƒ¯áƒ áƒ”áƒ“áƒ˜áƒ¡ áƒáƒ’áƒ”áƒ‘áƒ£áƒšáƒ”áƒ‘áƒ"
//    - áƒ¥áƒ˜áƒ›áƒ˜áƒ: "áƒáƒ¢áƒáƒ›áƒ˜áƒ¡ áƒáƒ’áƒ”áƒ‘áƒ£áƒšáƒ”áƒ‘áƒ", "áƒ¥áƒ˜áƒ›áƒ˜áƒ£áƒ áƒ˜ áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜"
//    - áƒ¤áƒ˜áƒ–áƒ˜áƒ™áƒ: "áƒœáƒ˜áƒ£áƒ¢áƒáƒœáƒ˜áƒ¡ áƒ™áƒáƒœáƒáƒœáƒ”áƒ‘áƒ˜", "áƒ”áƒšáƒ”áƒ¥áƒ¢áƒ áƒáƒ‘áƒ"

// 5. á²—á²á²•á²˜á²“á²á²œ á²á²ªá²˜á²šá²”á²‘á²:
//    âŒ áƒáƒ  áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ˜ (áƒ’áƒáƒ áƒ“áƒ áƒ“áƒáƒ¬áƒ§áƒ”áƒ‘áƒ˜áƒ—áƒ˜ áƒ™áƒšáƒáƒ¡áƒ”áƒ‘áƒ˜áƒ¡áƒ)
//    âŒ áƒáƒ  áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ áƒ‘áƒ£áƒœáƒ“áƒáƒ•áƒáƒœáƒ˜ áƒ¤áƒáƒ áƒ›áƒ£áƒšáƒ˜áƒ áƒ”áƒ‘áƒ”áƒ‘áƒ˜
//    âŒ áƒáƒ  áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ áƒáƒ áƒáƒ–áƒ áƒáƒ•áƒáƒœáƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ˜
//    âŒ áƒáƒ  áƒ˜áƒ§áƒáƒ¡ áƒ áƒ—áƒ£áƒšáƒ˜ áƒ¢áƒ”áƒ áƒ›áƒ˜áƒœáƒáƒšáƒáƒ’áƒ˜áƒ áƒ›áƒªáƒ˜áƒ áƒ” áƒ™áƒšáƒáƒ¡áƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡

// 6. JSON áƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ˜:
// {
//   "type": "test",
//   "topic": "áƒ—áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ (áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒáƒ“)",
//   "subject": "áƒ¡áƒáƒ’áƒáƒœáƒ˜",
//   "grade": "áƒ™áƒšáƒáƒ¡áƒ˜ (1-12)",
//   "difficulty": "áƒáƒ“áƒ•áƒ˜áƒšáƒ˜/áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ/áƒ áƒ—áƒ£áƒšáƒ˜",
//   "questions": [
//     {
//       "question": "áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ˜áƒ¡ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜?",
//       "options": ["áƒáƒáƒ¡áƒ£áƒ®áƒ˜ A", "áƒáƒáƒ¡áƒ£áƒ®áƒ˜ B", "áƒáƒáƒ¡áƒ£áƒ®áƒ˜ C", "áƒáƒáƒ¡áƒ£áƒ®áƒ˜ D"],
//       "correct": 0,
//       "explanation": "áƒ›áƒáƒ™áƒšáƒ” áƒáƒ®áƒ¡áƒœáƒ áƒ áƒáƒ¢áƒáƒ› áƒáƒ áƒ˜áƒ¡ áƒ”áƒ¡ áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ¡áƒ¬áƒáƒ áƒ˜"
//     }
//   ]
// }

// á²›á²œá²˜á²¨á²•á²œá²”á²šá²á²•á²á²œá²˜: 
// - correct áƒáƒ áƒ˜áƒ¡ áƒ˜áƒœáƒ“áƒ”áƒ¥áƒ¡áƒ˜ (0, 1, 2, 3)
// - explanation áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ›áƒáƒ™áƒšáƒ” áƒ“áƒ áƒ’áƒáƒ¡áƒáƒ’áƒ”áƒ‘áƒ˜
// - questions áƒ›áƒáƒ¡áƒ˜áƒ•áƒ¨áƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ–áƒ£áƒ¡áƒ¢áƒáƒ“ 5 áƒáƒ‘áƒ˜áƒ”áƒ¥áƒ¢áƒ˜
// - áƒ“áƒáƒáƒ‘áƒ áƒ£áƒœáƒ” áƒ›áƒ®áƒáƒšáƒáƒ“ JSON, áƒáƒ áƒáƒ¤áƒ”áƒ áƒ˜ áƒ¡áƒ®áƒ•áƒ!`;

// router.post("/chat", async (req: Request, res: Response) => {
//   try {
//     const { message, history } = req.body;

//     if (!message) {
//       return res.status(400).json({ error: "Message is required" });
//     }

//     // áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ: áƒ”áƒ®áƒ”áƒ‘áƒ áƒ—áƒ£ áƒáƒ áƒ áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒáƒ¡
//     const educationKeywords = [
//       "áƒ¢áƒ”áƒ¡áƒ¢",
//       "test",
//       "áƒ¨áƒ”áƒ™áƒ˜áƒ—áƒ®áƒ•",
//       "áƒ™áƒ˜áƒ—áƒ®áƒ•",
//       "áƒ¡áƒáƒ¨áƒ˜áƒœáƒáƒ",
//       "áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ",
//       "áƒ›áƒáƒ—áƒ”áƒ›áƒáƒ¢áƒ˜áƒ™",
//       "áƒ¥áƒáƒ áƒ—áƒ£áƒš",
//       "áƒ˜áƒœáƒ’áƒšáƒ˜áƒ¡áƒ£áƒ ",
//       "áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜",
//       "áƒ’áƒ”áƒáƒ’áƒ áƒáƒ¤áƒ˜",
//       "áƒ‘áƒ˜áƒáƒšáƒáƒ’áƒ˜",
//       "áƒ¥áƒ˜áƒ›áƒ˜",
//       "áƒ¤áƒ˜áƒ–áƒ˜áƒ™",
//       "áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ˜áƒ™",
//       "áƒ’áƒáƒœáƒ›áƒáƒ áƒ¢",
//       "áƒáƒ®áƒ¡áƒ”áƒœ",
//       "áƒ áƒáƒ’áƒáƒ ",
//       "áƒ áƒ áƒáƒ áƒ˜áƒ¡",
//       "áƒ áƒáƒ¢áƒáƒ›",
//       "math",
//       "geography",
//       "biology",
//       "chemistry",
//       "physics",
//       "history",
//       "explain",
//       "áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒš",
//       "áƒáƒ›áƒáƒ®áƒ¡áƒœ",
//       "áƒ¡áƒ¬áƒáƒ•áƒš",
//       "áƒ™áƒšáƒáƒ¡",
//       "áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒš",
//       "áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ”áƒ‘",
//       "áƒ¡áƒáƒ’áƒáƒœ",
//       "áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒš",
//     ];

//     const isEducationRelated = educationKeywords.some((keyword) =>
//       message.toLowerCase().includes(keyword.toLowerCase())
//     );

//     // áƒ—áƒ£ áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒáƒ¡áƒ—áƒáƒœ áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜
//     if (
//       !isEducationRelated &&
//       !message.toLowerCase().includes("áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ") &&
//       !message.toLowerCase().includes("hello")
//     ) {
//       return res.json({
//         response: `ğŸ˜Š áƒ‘áƒáƒ“áƒ˜áƒ¨áƒ˜, áƒ›áƒ” áƒ•áƒáƒ  áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ“áƒ áƒ“áƒáƒ•áƒ”áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ˜ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒ¡áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ áƒ›áƒáƒ¡áƒáƒšáƒ”áƒ‘áƒ¨áƒ˜!

// ğŸ“š áƒ¨áƒ”áƒ›áƒ˜áƒ«áƒšáƒ˜áƒ áƒ“áƒáƒ’áƒ”áƒ®áƒ›áƒáƒ áƒ:
// - áƒ¡áƒáƒ¨áƒ˜áƒœáƒáƒ áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ’áƒ”áƒ‘áƒáƒ¨áƒ˜
// - áƒ¡áƒ®áƒ•áƒáƒ“áƒáƒ¡áƒ®áƒ•áƒ áƒ¡áƒáƒ’áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒáƒ®áƒ¡áƒœáƒáƒ¨áƒ˜
// - áƒ¢áƒ”áƒ¡áƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒáƒ¨áƒ˜ áƒ“áƒ áƒ©áƒáƒ¢áƒáƒ áƒ”áƒ‘áƒáƒ¨áƒ˜
// - áƒ¡áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ áƒ›áƒáƒ¡áƒáƒšáƒ˜áƒ¡ áƒ’áƒáƒáƒ–áƒ áƒ”áƒ‘áƒáƒ¨áƒ˜

// ğŸ¯ áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ”áƒ‘áƒ˜ áƒ áƒáƒª áƒ¨áƒ”áƒ›áƒ˜áƒ«áƒšáƒ˜áƒ:
// - "áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒáƒ˜áƒ—áƒáƒ’áƒáƒ áƒáƒ¡ áƒ—áƒ”áƒáƒ áƒ”áƒ›áƒ"
// - "áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒáƒ¨áƒ˜"
// - "áƒ áƒáƒ’áƒáƒ  áƒ•áƒáƒ›áƒáƒ®áƒ¡áƒœáƒ áƒ”áƒ¡ áƒ’áƒáƒœáƒ¢áƒáƒšáƒ”áƒ‘áƒ?"
// - "áƒ áƒ áƒáƒ áƒ˜áƒ¡ áƒ¤áƒáƒ¢áƒáƒ¡áƒ˜áƒœáƒ—áƒ”áƒ–áƒ˜?"

// áƒ“áƒáƒ›áƒ˜áƒ¡áƒ•áƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ áƒ¡áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ áƒ›áƒáƒ¡áƒáƒšáƒáƒ–áƒ”! ğŸ“–âœ¨`,
//       });
//     }

//     const model = genAI.getGenerativeModel({
//       model: "gemini-1.5-flash",
//       generationConfig: {
//         temperature: 0.7,
//         topP: 0.8,
//         topK: 40,
//       },
//     });

//     // áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ¡ áƒ›áƒáƒ—áƒ®áƒáƒ•áƒœáƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ
//     const isTestRequest =
//       message.toLowerCase().includes("áƒ¢áƒ”áƒ¡áƒ¢") ||
//       message.toLowerCase().includes("test") ||
//       message.toLowerCase().includes("áƒ¨áƒ”áƒ™áƒ˜áƒ—áƒ®áƒ•") ||
//       (message.toLowerCase().includes("áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœ") &&
//         (message.toLowerCase().includes("áƒ™áƒ˜áƒ—áƒ®áƒ•") ||
//           message.toLowerCase().includes("áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ")));

//     let fullPrompt: string;
//     let shouldParseTest = false;

//     if (isTestRequest) {
//       shouldParseTest = true;
//       fullPrompt = `${TEST_CREATION_PROMPT}

// áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ¡ áƒ›áƒáƒ—áƒ®áƒáƒ•áƒœáƒ: "${message}"

// áƒ’áƒáƒ˜áƒáƒ–áƒ áƒ” áƒ áƒ áƒ—áƒ”áƒ›áƒáƒ–áƒ” áƒ¡áƒ£áƒ áƒ¡ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ“áƒ áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ 5 áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ JSON áƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ¨áƒ˜.`;
//     } else {
//       fullPrompt = `${EDUCATION_SYSTEM_PROMPT}

// áƒ›áƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ¡ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ: "${message}"

// áƒ’áƒáƒ”áƒ®áƒ˜áƒšáƒ” áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ¡ áƒ§áƒ£áƒ áƒáƒ“áƒ¦áƒ”áƒ‘áƒ˜áƒ— áƒ“áƒ áƒ›áƒ˜áƒ”áƒªáƒ˜ áƒ¡áƒ áƒ£áƒšáƒ˜, áƒ’áƒáƒ¡áƒáƒ’áƒ”áƒ‘áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ¥áƒáƒ áƒ—áƒ£áƒš áƒ”áƒœáƒáƒ–áƒ”.`;
//     }

//     const result = await model.generateContent(fullPrompt);
//     const response = await result.response;
//     let text = response.text();

//     // áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ¡ áƒáƒáƒ áƒ¡áƒ˜áƒœáƒ’áƒ˜
//     let testData = null;
//     if (shouldParseTest) {
//       try {
//         // JSON-áƒ˜áƒ¡ áƒáƒ›áƒáƒ¦áƒ”áƒ‘áƒ markdown áƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ˜áƒ“áƒáƒœ
//         const jsonMatch =
//           text.match(/```json\s*([\s\S]*?)\s*```/) ||
//           text.match(/```\s*([\s\S]*?)\s*```/) ||
//           text.match(/\{[\s\S]*\}/);

//         if (jsonMatch) {
//           const jsonStr = jsonMatch[1] || jsonMatch[0];
//           testData = JSON.parse(jsonStr);

//           // áƒ•áƒáƒšáƒ˜áƒ“áƒáƒªáƒ˜áƒ
//           if (
//             testData &&
//             testData.questions &&
//             testData.questions.length === 5
//           ) {
//             text = `âœ… áƒ¨áƒ”áƒ•áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ—áƒ”áƒ›áƒáƒ–áƒ”: **${testData.topic}**

// ğŸ“š **áƒ¡áƒáƒ’áƒáƒœáƒ˜:** ${testData.subject}
// ğŸ“Š **áƒ™áƒšáƒáƒ¡áƒ˜:** ${testData.grade}
// âš¡ **áƒ¡áƒ˜áƒ áƒ—áƒ£áƒšáƒ”:** ${testData.difficulty}

// áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ¡ 5 áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ¡. áƒ’áƒ˜áƒ¡áƒ£áƒ áƒ•áƒ”áƒ‘ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ”áƒ‘áƒ¡! ğŸŒŸ

// áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡ áƒ’áƒáƒªáƒ”áƒ›áƒ!`;
//           } else {
//             throw new Error("Invalid test structure");
//           }
//         } else {
//           throw new Error("JSON not found in response");
//         }
//       } catch (e) {
//         console.error("Failed to parse test JSON:", e);
//         testData = null;
//         text = `ğŸ˜” áƒ‘áƒáƒ“áƒ˜áƒ¨áƒ˜, áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ•áƒ«áƒ”áƒšáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ. áƒ’áƒ—áƒ®áƒáƒ• áƒ¡áƒªáƒáƒ“áƒ áƒ™áƒ˜áƒ“áƒ”áƒ• áƒ”áƒ áƒ—áƒ®áƒ”áƒš áƒ£áƒ¤áƒ áƒ áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒšáƒ˜ áƒ—áƒ”áƒ›áƒ˜áƒ—.

// áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒáƒ“:
// - "áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒáƒ˜áƒ—áƒáƒ’áƒáƒ áƒáƒ¡ áƒ—áƒ”áƒáƒ áƒ”áƒ›áƒáƒ–áƒ”"
// - "áƒ›áƒ­áƒ˜áƒ áƒ“áƒ”áƒ‘áƒ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒáƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒáƒ¨áƒ˜"
// - "áƒ’áƒáƒ›áƒ˜áƒ™áƒ”áƒ—áƒ” áƒ¢áƒ”áƒ¡áƒ¢áƒ˜ áƒ¥áƒ˜áƒ›áƒ˜áƒ£áƒ  áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ–áƒ”"`;
//       }
//     }

//     res.json({
//       response: text,
//       test: testData,
//     });
//   } catch (error: any) {
//     console.error("AI Chat Error:", error);

//     // Google API error handling
//     if (error.message?.includes("API key")) {
//       return res.status(500).json({
//         error: "API Configuration Error",
//         response:
//           "ğŸ˜” áƒ¢áƒ”áƒ¥áƒœáƒ˜áƒ™áƒ£áƒ áƒ˜ áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒ API key-áƒ—áƒáƒœ. áƒ’áƒ—áƒ®áƒáƒ• áƒ¨áƒ”áƒáƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ¡.",
//       });
//     }

//     if (error.message?.includes("quota")) {
//       return res.status(429).json({
//         error: "Rate Limit Exceeded",
//         response:
//           "â³ áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ‘áƒ”áƒ•áƒ áƒ˜ áƒ›áƒáƒ—áƒ®áƒáƒ•áƒœáƒáƒ. áƒ’áƒ—áƒ®áƒáƒ• áƒ“áƒáƒ”áƒšáƒáƒ“áƒ 1 áƒ¬áƒ£áƒ—áƒ¡ áƒ“áƒ áƒ¡áƒªáƒáƒ“áƒ áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ.",
//       });
//     }

//     res.status(500).json({
//       error: "Internal server error",
//       response:
//         "ğŸ˜” áƒ‘áƒáƒ“áƒ˜áƒ¨áƒ˜, áƒ“áƒáƒ¤áƒ˜áƒ¥áƒ¡áƒ˜áƒ áƒ“áƒ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ. áƒ’áƒ—áƒ®áƒáƒ• áƒ¡áƒªáƒáƒ“áƒ áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ áƒáƒœ áƒ’áƒáƒœáƒáƒáƒ®áƒšáƒ áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜.",
//     });
//   }
// });

// export default router;
